<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ETA Calculator</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      margin: 0;
      padding: 0;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .logo-animate {
      animation: fadeIn 1s ease-in;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: #1E3A8A;
      color: white;
      text-align: center;
      border-radius: 6px;
      padding: 4px 8px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      white-space: nowrap;
      min-width: 0;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1E3A8A transparent transparent transparent;
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .border-blue-200 {
      border-color: #DBEAFE;
    }
    
    .bg-gradient-to-r {
      background-image: linear-gradient(to right, var(--tw-gradient-stops));
    }
    
    .from-blue-50 {
      --tw-gradient-from: #EFF6FF;
      --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0));
    }
    
    .to-white {
      --tw-gradient-to: #FFFFFF;
    }
    
    .app-container {
      width: 100%;
      max-width: 36rem;
      min-height: 600px;
    }
    
    .summary-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .summary-header {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 0.75rem;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      align-items: flex-end;
    }
    
    .summary-label {
      font-weight: 500;
      color: #374151;
    }
    
    .summary-value {
      color: #4b5563;
    }
    
    .final-price {
      background-color: #F3E8FF;
      padding: 0.5rem;
      border-radius: 0.375rem;
      font-size: 1.25rem;
    }
    
    .disclaimer-section {
      margin-top: 1rem;
      padding: 0.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: left;
    }
    
    @keyframes blink {
      50% { opacity: 0; }
    }
    .blink {
      animation: blink 1s step-end infinite;
      color: red;
      font-weight: bold;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      width: 28rem;
      text-align: center;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23374151' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.5em;
      padding: 0.75rem 2.5rem 0.75rem 1rem;
      border: 1px solid #D1D5DB;
      border-radius: 0.375rem;
      background-color: #F9FAFB;
      transition: all 0.2s ease-in-out;
      width: 100%;
      font-size: 1rem;
      color: #374151;
    }
    
    select:focus {
      border-color: #3B82F6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background-color: #FFFFFF;
      outline: none;
    }
    
    select:hover {
      border-color: #93C5FD;
      background-color: #FFFFFF;
    }
    
    select:disabled {
      background-color: #F3F4F6;
      color: #6B7280;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    @media (max-width: 640px) {
      .app-container {
        padding: 1rem;
      }
      label {
        font-size: 14px;
      }
      input, select, button {
        font-size: 14px;
        padding: 0.5rem;
      }
      h1 {
        font-size: 1.5rem;
      }
      .result-text {
        font-size: 12px;
      }
      .tooltip .tooltip-text {
        width: 200px;
      }
      .summary-header {
        font-size: 1rem;
      }
      .final-price {
        font-size: 1rem;
      }
      .modal-content {
        padding: 1rem;
        width: 90%;
      }
    }
  </style>
</head>
<body class="bg-gray-200 min-h-screen flex items-center justify-center">
  <div id="root"></div>
  
  <script type="text/babel">
    const portsData = [
      { pod: "Chattogram", additionalPrice: 0, transitTime: 65, country: "Bangladesh", region: "Bangladesh" },
      { pod: "Chittagong", additionalPrice: 0, transitTime: 65, country: "Bangladesh", region: "Bangladesh" },
      { pod: "Anqing", additionalPrice: 8, transitTime: 60, country: "China", region: "South" },
      { pod: "Baiyang Port, Yichang", additionalPrice: 5, transitTime: 70, country: "China", region: "South" },
      { pod: "Changsha", additionalPrice: 7, transitTime: 75, country: "China", region: "South" },
      { pod: "Changzhou", additionalPrice: 16, transitTime: 60, country: "China", region: "South" },
      { pod: "Chongqing", additionalPrice: 12, transitTime: 75, country: "China", region: "South" },
      { pod: "Dalian", additionalPrice: 4, transitTime: 60, country: "China", region: "North" },
      { pod: "Dandong", additionalPrice: 8, transitTime: 60, country: "China", region: "North" },
      { pod: "Dongfa Old Port, Nansha", additionalPrice: 15, transitTime: 60, country: "China", region: "South" },
      { pod: "Huangpu", additionalPrice: 10, transitTime: 60, country: "China", region: "South" },
      { pod: "Jisi Port, Huangpu New Port", additionalPrice: 10, transitTime: 60, country: "China", region: "South" },
      { pod: "Jiujiang", additionalPrice: 9, transitTime: 60, country: "China", region: "South" },
      { pod: "Luzhou", additionalPrice: 32, transitTime: 75, country: "China", region: "South" },
      { pod: "Nanjing", additionalPrice: 0, transitTime: 60, country: "China", region: "South" },
      { pod: "Nansha", additionalPrice: 15, transitTime: 60, country: "China", region: "South" },
      { pod: "Ningbo", additionalPrice: 4, transitTime: 55, country: "China", region: "South" },
      { pod: "Qingdao", additionalPrice: 0, transitTime: 55, country: "China", region: "North" },
      { pod: "Qingyuan", additionalPrice: 13, transitTime: 60, country: "China", region: "South" },
      { pod: "Sanshui", additionalPrice: 0, transitTime: 60, country: "China", region: "South" },
      { pod: "Shanghai", additionalPrice: 0, transitTime: 55, country: "China", region: "South" },
      { pod: "Shekou", additionalPrice: 1, transitTime: 55, country: "China", region: "South" },
      { pod: "Tianjin", additionalPrice: 0, transitTime: 60, country: "China", region: "North" },
      { pod: "Wuhan", additionalPrice: 0, transitTime: 65, country: "China", region: "highway" },
      { pod: "Xiamen", additionalPrice: 0, transitTime: 55, country: "China", region: "South" },
      { pod: "Xingang, Tianjin", additionalPrice: 0, transitTime: 60, country: "China", region: "North" },
      { pod: "Xinsha Port, Huangpu", additionalPrice: 10, transitTime: 65, country: "China", region: "South" },
      { pod: "Yantian", additionalPrice: 0, transitTime: 55, country: "China", region: "South" },
      { pod: "Yichang", additionalPrice: 12, transitTime: 70, country: "China", region: "South" },
      { pod: "Zhangjiagang", additionalPrice: 4, transitTime: 65, country: "China", region: "South" },
      { pod: "Belawan", additionalPrice: 10, transitTime: 50, country: "Indonesia", region: "Indonesia" },
      { pod: "Jakarta", additionalPrice: 10, transitTime: 50, country: "Indonesia", region: "Indonesia" },
      { pod: "Surabaya", additionalPrice: 10, transitTime: 50, country: "Indonesia", region: "Indonesia" },
      { pod: "Busan", additionalPrice: 0, transitTime: 55, country: "Korea", region: "Korea" },
      { pod: "Bintulu", additionalPrice: 15, transitTime: 65, country: "Malaysia", region: "Malaysia" },
      { pod: "Kuching", additionalPrice: 15, transitTime: 50, country: "Malaysia", region: "Malaysia" },
      { pod: "Port Klang", additionalPrice: 0, transitTime: 40, country: "Malaysia", region: "Malaysia" },
      { pod: "Penang", additionalPrice: 0, transitTime: 40, country: "Malaysia", region: "Malaysia" },
      { pod: "Sandakan", additionalPrice: 15, transitTime: 55, country: "Malaysia", region: "Malaysia" },
      { pod: "Sibu", additionalPrice: 15, transitTime: 45, country: "Malaysia", region: "Malaysia" },
      { pod: "Tawau", additionalPrice: 15, transitTime: 50, country: "Malaysia", region: "Malaysia" },
      { pod: "Yangon", additionalPrice: 0, transitTime: 50, country: "Myanmar", region: "Myanmar" },
      { pod: "Batangas", additionalPrice: 14, transitTime: 55, country: "Philippines", region: "Philippines" },
      { pod: "Cebu", additionalPrice: 0, transitTime: 60, country: "Philippines", region: "Philippines" },
      { pod: "Davao", additionalPrice: 0, transitTime: 50, country: "Philippines", region: "Philippines" },
      { pod: "Manila", additionalPrice: 0, transitTime: 55, country: "Philippines", region: "Philippines" },
      { pod: "Manila North Harbour", additionalPrice: 0, transitTime: 55, country: "Philippines", region: "Philippines" },
      { pod: "Manila South Harbour", additionalPrice: 0, transitTime: 55, country: "Philippines", region: "Philippines" },
      { pod: "Subic Bay", additionalPrice: 0, transitTime: 50, country: "Philippines", region: "Philippines" },
      { pod: "Singapore", additionalPrice: "Spot", transitTime: 45, country: "Singapore", region: "Singapore" },
      { pod: "Colombo", additionalPrice: 0, transitTime: 65, country: "Sri Lanka", region: "Sri Lanka" },
      { pod: "Kaohsiung", additionalPrice: 0, transitTime: 55, country: "Taiwan", region: "Taiwan" },
      { pod: "Keelung", additionalPrice: 8, transitTime: 55, country: "Taiwan", region: "Taiwan" },
      { pod: "Taichung", additionalPrice: 0, transitTime: 60, country: "Taiwan", region: "Taiwan" },
      { pod: "Taoyuan", additionalPrice: 5, transitTime: 55, country: "Taiwan", region: "Taiwan" },
      { pod: "Bangkok", additionalPrice: 0, transitTime: 50, country: "Thailand", region: "Thailand" },
      { pod: "Laem Chabang", additionalPrice: 0, transitTime: 50, country: "Thailand", region: "Thailand" },
      { pod: "Songkhla", additionalPrice: 10, transitTime: 50, country: "Thailand", region: "Thailand" },
      { pod: "Cai Mep Port, Ho Chi Minh", additionalPrice: 0, transitTime: 70, country: "Vietnam", region: "Vietnam" },
      { pod: "Cat Lai Port", additionalPrice: 0, transitTime: 50, country: "Vietnam", region: "Vietnam" },
      { pod: "Danang", additionalPrice: 0, transitTime: 50, country: "Vietnam", region: "Vietnam" },
      { pod: "Haiphong", additionalPrice: 0, transitTime: 50, country: "Vietnam", region: "Vietnam" },
      { pod: "Ho Chi Minh City Port", additionalPrice: 0, transitTime: 50, country: "Vietnam", region: "Vietnam" },
    ];

    const formatNumber = (num, decimals = 0) => {
      if (isNaN(num)) return "0";
      return Math.round(Number(num)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };

    const formatDate = (date) => {
      if (!(date instanceof Date) || isNaN(date)) return "Invalid Date";
      return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
    };

    const formatTimeWithSeconds = (date) => {
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const seconds = date.getSeconds();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const formattedHours = hours % 12 || 12;
      return `${formattedHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ${ampm}`;
    };

    const formatFullDateTime = (date) => {
      return date.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: 'Asia/Hong_Kong'
      }) + ' HKT';
    };

    const getDaysDifference = (date1, date2) => {
      const diffTime = Math.abs(date2 - date1);
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    };

    const addDays = (date, days) => {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    };

    const subtractDays = (date, days) => {
      const result = new Date(date);
      result.setDate(result.getDate() - days);
      return result;
    };

    const Tooltip = ({ children, text }) => (
      <div className="tooltip">
        {children}
        <span className="tooltip-text">{text}</span>
      </div>
    );

    const AlertCircle = () => (
      <svg className="w-4 h-6" fill="black" viewBox="0 0 20 20">
        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
      </svg>
    );

    const Loader = () => (
      <svg className="animate-spin w-4 h-4" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
      </svg>
    );

    const ETACalculator = () => {
      const today = new Date('2025-07-18T15:30:00+08:00');
      const defaultEtaDate = new Date(today);
      defaultEtaDate.setDate(today.getDate() + 80);
      const [eta, setEta] = React.useState(defaultEtaDate.toISOString().split('T')[0]);
      const [country, setCountry] = React.useState('');
      const [region, setRegion] = React.useState('');
      const [pod, setPod] = React.useState('');
      const [unitPrice, setUnitPrice] = React.useState('');
      const [smallBags20kg, setSmallBags20kg] = React.useState(false);
      const [smallBagsKraft, setSmallBagsKraft] = React.useState(false);
      const [boricAcidLowSulphate, setBoricAcidLowSulphate] = React.useState(false);
      const [boricAcidUltraLowSulphate, setBoricAcidUltraLowSulphate] = React.useState(false);
      const [result, setResult] = React.useState(null);
      const [errors, setErrors] = React.useState({
        eta: '',
        country: '',
        region: '',
        pod: '',
        unitPrice: '',
        smallBags: '',
        boricAcid: ''
      });
      const [isLoading, setIsLoading] = React.useState(false);
      const [recentCalculations, setRecentCalculations] = React.useState([]);
      const [currentTime, setCurrentTime] = React.useState(new Date());
      const [showWelcome, setShowWelcome] = React.useState(true);
      const etaInputRef = React.useRef(null);

      React.useEffect(() => {
        const timer = setInterval(() => {
          setCurrentTime(new Date());
        }, 1000);
        return () => clearInterval(timer);
      }, []);

      React.useEffect(() => {
        const saved = localStorage.getItem('recentCalculationsETA');
        if (saved) {
          try {
            setRecentCalculations(JSON.parse(saved));
          } catch (e) {
            console.error('Failed to parse recentCalculationsETA:', e);
          }
        }
      }, []);

      React.useEffect(() => {
        if (!showWelcome) {
          etaInputRef.current?.focus();
        }
      }, [showWelcome]);

      const uniqueCountries = [...new Set(portsData.map(p => p.country))].sort();
      const regions = ["North", "South"];
      const availablePods = portsData
        .filter(p => p.country === country && (country !== "China" || p.region === region))
        .map(p => p.pod)
        .sort();

      const clearErrors = () => {
        setErrors({
          eta: '',
          country: '',
          region: '',
          pod: '',
          unitPrice: '',
          smallBags: '',
          boricAcid: ''
        });
      };

      const handleEtaChange = (e) => {
        setEta(e.target.value);
        setResult(null);
        clearErrors();
      };

      const handleSetToday = () => {
        setEta(today.toISOString().split('T')[0]);
        setResult(null);
        clearErrors();
      };

      const handleCountryChange = (e) => {
        setCountry(e.target.value);
        setRegion('');
        setPod('');
        setUnitPrice('');
        setSmallBags20kg(false);
        setSmallBagsKraft(false);
        setBoricAcidLowSulphate(false);
        setBoricAcidUltraLowSulphate(false);
        setResult(null);
        clearErrors();
      };

      const handleRegionChange = (e) => {
        setRegion(e.target.value);
        setPod('');
        setUnitPrice('');
        setSmallBags20kg(false);
        setSmallBagsKraft(false);
        setBoricAcidLowSulphate(false);
        setBoricAcidUltraLowSulphate(false);
        setResult(null);
        clearErrors();
      };

      const handlePodChange = (e) => {
        setPod(e.target.value);
        setUnitPrice('');
        setSmallBags20kg(false);
        setSmallBagsKraft(false);
        setBoricAcidLowSulphate(false);
        setBoricAcidUltraLowSulphate(false);
        setResult(null);
        clearErrors();
      };

      const handleUnitPriceChange = (e) => {
        const value = e.target.value;
        if (value === "" || /^\d*$/.test(value)) {
          setUnitPrice(value);
          setResult(null);
          clearErrors();
        }
      };

      const handleUnitPriceBlur = () => {
        if (unitPrice) {
          const formatted = parseInt(unitPrice, 10);
          if (!isNaN(formatted)) {
            setUnitPrice(formatted.toString());
          }
        }
      };

      const handleSmallBags20kgChange = (e) => {
        setSmallBags20kg(e.target.checked);
        if (e.target.checked && smallBagsKraft) {
          setSmallBagsKraft(false);
        }
        setResult(null);
        clearErrors();
      };

      const handleSmallBagsKraftChange = (e) => {
        setSmallBagsKraft(e.target.checked);
        if (e.target.checked && smallBags20kg) {
          setSmallBags20kg(false);
        }
        setResult(null);
        clearErrors();
      };

      const handleBoricAcidLowSulphateChange = (e) => {
        setBoricAcidLowSulphate(e.target.checked);
        if (e.target.checked && boricAcidUltraLowSulphate) {
          setBoricAcidUltraLowSulphate(false);
        }
        setResult(null);
        clearErrors();
      };

      const handleBoricAcidUltraLowSulphateChange = (e) => {
        setBoricAcidUltraLowSulphate(e.target.checked);
        if (e.target.checked && boricAcidLowSulphate) {
          setBoricAcidLowSulphate(false);
        }
        setResult(null);
        clearErrors();
      };

      const handleReset = () => {
        setEta(defaultEtaDate.toISOString().split('T')[0]);
        setCountry('');
        setRegion('');
        setPod('');
        setUnitPrice('');
        setSmallBags20kg(false);
        setSmallBagsKraft(false);
        setBoricAcidLowSulphate(false);
        setBoricAcidUltraLowSulphate(false);
        setResult(null);
        clearErrors();
        etaInputRef.current?.focus();
      };

      const clearHistory = () => {
        setRecentCalculations([]);
        localStorage.removeItem('recentCalculationsETA');
      };

      const calculateETA = (e) => {
        e.preventDefault();
        setIsLoading(true);

        setTimeout(() => {
          const newErrors = { ...errors };
          let hasError = false;

          if (!eta) {
            newErrors.eta = "Please select a required arrival date";
            hasError = true;
          }

          if (!country) {
            newErrors.country = "Please select a country";
            hasError = true;
          }

          if (country === "China" && !region) {
            newErrors.region = "Please select a region";
            hasError = true;
          }

          if (!pod) {
            newErrors.pod = "Please select a port of discharge";
            hasError = true;
          }

          if (unitPrice) {
            const unitPriceValue = parseInt(unitPrice, 10);
            if (isNaN(unitPriceValue) || unitPriceValue <= 0) {
              newErrors.unitPrice = "Unit price must be a positive number";
              hasError = true;
            } else if (unitPriceValue > 10000) {
              newErrors.unitPrice = "Unit price is too large. Please enter a value up to 10,000 USD/MT";
              hasError = true;
            }
          }

          if (smallBags20kg && smallBagsKraft) {
            newErrors.smallBags = "Please select only one small bags option";
            hasError = true;
          }

          if (boricAcidLowSulphate && boricAcidUltraLowSulphate) {
            newErrors.boricAcid = "Please select only one Boric Acid option";
            hasError = true;
          }

          if ((smallBags20kg || smallBagsKraft || boricAcidLowSulphate || boricAcidUltraLowSulphate) && !unitPrice) {
            newErrors.unitPrice = "Unit price is required when a packing or boric acid option is selected";
            hasError = true;
          }

          setErrors(newErrors);

          if (hasError) {
            setIsLoading(false);
            return;
          }

          const selectedPort = portsData.find(
            p => p.pod === pod && p.country === country && (country !== "China" || p.region === region)
          );

          if (!selectedPort) {
            setIsLoading(false);
            setResult({ message: "Invalid port selection. Please try again.", summary: {}, notes: [] });
            return;
          }

          const etaDate = new Date(eta);
          if (isNaN(etaDate)) {
            setErrors({ ...newErrors, eta: "Invalid date format" });
            setIsLoading(false);
            return;
          }
          etaDate.setHours(0, 0, 0, 0);

          const todayDate = currentTime instanceof Date && !isNaN(currentTime) ? new Date(currentTime) : new Date();
          todayDate.setHours(0, 0, 0, 0);

          const transitTime = selectedPort.transitTime;
          const preparationTime = 20;
          const calculatedEtd = subtractDays(etaDate, transitTime);
          const earliestEtd = addDays(todayDate, preparationTime);

          let resultObj;
          let reviseETAMessage = '';

          if (calculatedEtd < earliestEtd) {
            const earliestEta = addDays(earliestEtd, transitTime);
            reviseETAMessage = `<span class='blink'><b>We cannot process the order.</b></span><br><br>The Estimated Date of Departure (ETD) must be at least 20 days from today, which is on or after <strong style='color: orange'>${formatDate(earliestEtd)}</strong>. With the current Required Date of Arrival (ETA), the calculated ETD is <strong style='color: green'>${formatDate(calculatedEtd)}</strong>. We recommend adjusting to the earliest feasible ETA of <strong style='color: purple'>${formatDate(earliestEta)}</strong>.`;
            resultObj = { message: reviseETAMessage, summary: {}, notes: [] };
            if ((smallBags20kg || smallBagsKraft || boricAcidLowSulphate || boricAcidUltraLowSulphate) && !unitPrice) {
              resultObj.notes.push({ text: "❖ Unit price is required when a packing or boric acid option is selected.", id: 1 });
            }
            setResult(resultObj);
            setIsLoading(false);
            return;
          }

          const formattedEta = formatDate(etaDate);
          const formattedEtd = formatDate(calculatedEtd);

          resultObj = {
            message: `The shipment is scheduled to arrive at <strong style="color: #10B981">${pod}, ${country.toUpperCase()}</strong> on the Required Date of Arrival (ETA) <strong style="color: #808080">${formattedEta}</strong>, with an Estimated Date of Departure (ETD) of <strong style="color: #3B82F6">${formattedEtd}</strong>.`,
            summary: {
              eta: formattedEta,
              pod: `${pod}, ${country.toUpperCase()}`,
              etd: formattedEtd,
              preparationTime: `${preparationTime} days`,
              transitTime: `${transitTime} days`,
            },
            notes: []
          };

          if (unitPrice) {
            let unitPriceValue = parseInt(unitPrice, 10);
            const portAdditionalPrice = selectedPort.additionalPrice === "Spot" ? 0 : parseInt(selectedPort.additionalPrice, 10);
            let bagAdditionalPrice = 0;
            let bagNote = '';
            let boricAcidAdditionalPrice = 0;
            let boricAcidNote = '';

            if (smallBags20kg) {
              bagAdditionalPrice = 15;
              bagNote = "<br>❖ Small bags - 20kg/25kg FFS/Laminated PP adds 15 USD/MT.";
            } else if (smallBagsKraft) {
              bagAdditionalPrice = 25;
              bagNote = "<br>❖ Small bags - 20kg/25kg Kraft adds 25 USD/MT.";
            }

            if (boricAcidLowSulphate) {
              boricAcidAdditionalPrice = 20;
              boricAcidNote = "<br>❖ Boric Acid with Low Sulphate adds 20 USD/MT.";
            } else if (boricAcidUltraLowSulphate) {
              boricAcidAdditionalPrice = 300;
              boricAcidNote = "<br>❖ Boric Acid with Ultra Low Sulphate adds 300 USD/MT.";
            }

            const finalPrice = unitPriceValue + portAdditionalPrice + bagAdditionalPrice + boricAcidAdditionalPrice;

            resultObj = {
              message: `The shipment is scheduled to arrive at <strong style="color: #10B981">${pod}, ${country.toUpperCase()}</strong> on the Required Date of Arrival (ETA) <strong style="color: #808080">${formattedEta}</strong>, with an Estimated Date of Departure (ETD) of <strong style="color: #3B82F6">${formattedEtd}</strong> and a total price of <strong style="color: #9333EA">${formatNumber(finalPrice)}</strong> USD/MT.`,
              summary: {
                eta: formattedEta,
                pod: `${pod}, ${country.toUpperCase()}`,
                etd: formattedEtd,
                preparationTime: `${preparationTime} days`,
                transitTime: `${transitTime} days`,
                unitPrice: `${formatNumber(unitPriceValue)} USD/MT`,
                portAdditionalPrice: selectedPort.additionalPrice === "Spot" ? "Spot" : `${formatNumber(portAdditionalPrice)} USD/MT`,
                bagAdditionalPrice: bagAdditionalPrice ? `${formatNumber(bagAdditionalPrice)} USD/MT` : null,
                boricAcidAdditionalPrice: boricAcidAdditionalPrice ? `${formatNumber(boricAcidAdditionalPrice)} USD/MT` : null,
                finalPrice: `${formatNumber(finalPrice)} USD/MT`
              },
              notes: []
            };

            if (bagNote) {
              resultObj.notes.push({ text: bagNote, id: resultObj.notes.length + 1 });
            }
            if (boricAcidNote) {
              resultObj.notes.push({ text: boricAcidNote, id: resultObj.notes.length + 1 });
            }
            if (selectedPort.additionalPrice === "Spot" && !resultObj.notes.some(note => note.text.includes("Spot"))) {
              resultObj.notes.push({ text: `Port additional price is 'Spot' for ${pod}, treated as 0 USD/MT.`, id: resultObj.notes.length + 1 });
            }
          } else if (selectedPort.additionalPrice === "Spot" && !resultObj.notes.some(note => note.text.includes("Spot"))) {
            resultObj.notes.push({ text: `Port additional price is 'Spot' for ${pod}, treated as 0 USD/MT.`, id: resultObj.notes.length + 1 });
          }

          setResult(resultObj);

          const newCalc = {
            message: resultObj.message,
            timestamp: new Date().toLocaleString()
          };
          const updatedCalcs = [newCalc, ...recentCalculations].slice(0, 5);
          setRecentCalculations(updatedCalcs);
          localStorage.setItem('recentCalculationsETA', JSON.stringify(updatedCalcs));

          setIsLoading(false);
        }, 500);
      };

      const copyResult = () => {
        if (result && result.message && result.summary) {
          const summaryText = Object.entries(result.summary)
            .filter(([key, value]) => value !== null)
            .map(([key, value]) => {
              const labels = {
                eta: "Required Date of Arrival (ETA)",
                pod: "Port of Discharge",
                etd: "Estimated Date of Departure (ETD)",
                preparationTime: "Preparation Time Needed",
                transitTime: "Transit Time",
                unitPrice: "Unit Price",
                portAdditionalPrice: "Port Additional Price",
                bagAdditionalPrice: "Bag Additional Price",
                boricAcidAdditionalPrice: "Boric Acid Additional Price",
                finalPrice: "Final Price"
              };
              return `${labels[key] || key}: ${value}`;
            })
            .join('\n');
          const textToCopy = `${result.message.replace(/<[^>]+>/g, '')}\n\n${summaryText}`;
          navigator.clipboard.writeText(textToCopy)
            .then(() => alert('Result copied to clipboard!'))
            .catch(err => console.error('Failed to copy text: ', err));
        }
      };

      return (
        <div className="bg-gray-200 min-h-screen flex items-center justify-center p-4 relative">
          {showWelcome && (
            <div className="modal">
              <div className="modal-content">
                <h2 className="text-2xl font-bold text-blue-900 mb-4">Welcome to the ETA Calculator</h2>
                <p className="text-gray-600 mb-6">We are pleased to welcome you to the ETA Calculator, a supertool designed to determine the Estimated Date of Departure (ETD) based on the Required Date of Arrival (ETA), destination country, port of discharge, and optional pricing details. This application ensures accurate scheduling and cost estimation for your shipments.</p>
                <button
                  onClick={() => setShowWelcome(false)}
                  className="bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600"
                >
                  Get Started
                </button>
              </div>
            </div>
          )}
          <div className="app-container bg-white shadow-lg rounded-lg">
            <div className="p-8 relative">
              <div className="absolute top-2 left-4 text-sm text-gray-600 font-medium" style={{ color: '#1E3A8A' }}>
                {formatTimeWithSeconds(currentTime)} | {formatFullDateTime(currentTime).split(' at ')[0]} | HKT
              </div>
              <div className="flex flex-col items-center mb-8">
                <img 
                  src="https://raw.githubusercontent.com/zmyeo54/etimaden-html-share/refs/heads/main/assets/Etimaden%20For%20Life%20Logo.png" 
                  alt="Etimaden For Life" 
                  className="h-25 logo-animate" 
                  style={{ marginTop: '30px', marginBottom: '50px' }}
                />
                <h1 className="text-3xl font-bold text-center text-blue-900 mb-[-10px] mt-[-50px]">ETA Calculator</h1>
              </div>
              <form onSubmit={calculateETA} className="space-y-6 mt-6">
                <div>
                  <Tooltip text="Select the required arrival date">
                    <label htmlFor="eta" className="block text-base font-medium text-gray-700 mb-2">
                      Required Date of Arrival (ETA)
                    </label>
                  </Tooltip>
                  <div className="flex space-x-2">
                    <input
                      id="eta"
                      type="date"
                      value={eta}
                      onChange={handleEtaChange}
                      ref={etaInputRef}
                      className="mt-1 flex-1 px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                      min={today.toISOString().split('T')[0]}
                    />
                    <button
                      type="button"
                      onClick={handleSetToday}
                      className="mt-1 bg-gray-200 text-gray-600 font-semibold py-3 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-600"
                    >
                      Today
                    </button>
                  </div>
                  {errors.eta && (
                    <div className="mt-2 flex items-center text-sm text-red-600">
                      <AlertCircle />
                      <span className="ml-1">{errors.eta}</span>
                    </div>
                  )}
                </div>
                <div>
                  <Tooltip text="Select the destination country">
                    <label htmlFor="country" className="block text-base font-medium text-gray-700 mb-2">
                      Country
                    </label>
                  </Tooltip>
                  <select
                    id="country"
                    value={country}
                    onChange={handleCountryChange}
                    className="mt-1 block w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-500"
                  >
                    <option value="">Select Country</option>
                    {uniqueCountries.map((c) => (
                      <option key={c} value={c}>{c}</option>
                    ))}
                  </select>
                  {errors.country && (
                    <div className="mt-2 flex items-center text-sm text-red-600">
                      <AlertCircle />
                      <span className="ml-1">{errors.country}</span>
                    </div>
                  )}
                </div>
                {country === "China" && (
                  <div>
                    <Tooltip text="Select the region (for China only)">
                      <label htmlFor="region" className="block text-base font-medium text-gray-700 mb-2">
                        Region
                      </label>
                    </Tooltip>
                    <select
                      id="region"
                      value={region}
                      onChange={handleRegionChange}
                      className="mt-1 block w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-500"
                    >
                      <option value="">Select Region</option>
                      {regions.map((r) => (
                        <option key={r} value={r}>{r}</option>
                      ))}
                    </select>
                    {errors.region && (
                      <div className="mt-2 flex items-center text-sm text-red-600">
                        <AlertCircle />
                        <span className="ml-1">{errors.region}</span>
                      </div>
                    )}
                  </div>
                )}
                <div>
                  <Tooltip text="Select the port of discharge">
                    <label htmlFor="pod" className="block text-base font-medium text-gray-700 mb-2">
                      Port of Discharge (POD)
                    </label>
                  </Tooltip>
                  <select
                    id="pod"
                    value={pod}
                    onChange={handlePodChange}
                    disabled={!country || (country === "China" && !region)}
                    className="mt-1 block w-full px-4 py-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-blue-500 disabled:bg-gray-100"
                  >
                    <option value="">Select Port of Discharge</option>
                    {availablePods.map((p) => (
                      <option key={p} value={p}>{p}</option>
                    ))}
                  </select>
                  {errors.pod && (
                    <div className="mt-2 flex items-center text-sm text-red-600">
                      <AlertCircle />
                      <span className="ml-1">{errors.pod}</span>
                    </div>
                  )}
                </div>
                <div className="mt-6 p-4 bg-white border border-gray-200 rounded-md shadow-md">
                  <h2 className="text-xl font-bold text-gray-800 mb-0">Price Calculator</h2>
                  <p className="text-sm text-gray-600 mb-2"><i>Optional - proceed without this if ETD alone suffices</i></p>
                  <div>
                    <Tooltip text="Enter the base unit price per metric ton (optional, e.g., 575)">
                      <label htmlFor="unitPrice" className="block text-base font-medium text-gray-700 mb-2">
                        Unit Price (USD/MT)
                      </label>
                    </Tooltip>
                    <input
                      id="unitPrice"
                      type="text"
                      value={unitPrice}
                      onChange={handleUnitPriceChange}
                      onBlur={handleUnitPriceBlur}
                      className="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-600"
                      placeholder="e.g., 575"
                    />
                    {errors.unitPrice && (
                      <div className="mt-2 flex items-center text-sm text-red-600">
                        <AlertCircle />
                        <span className="ml-1">{errors.unitPrice}</span>
                      </div>
                    )}
                    <div className="mt-4 space-y-2">
                      <h3 className="text-base font-medium text-gray-700">Packaging Options</h3>
                      <Tooltip text="Adds 15 USD per metric ton to the unit price">
                        <label className="flex items-center text-sm text-gray-600">
                          <input
                            type="checkbox"
                            checked={smallBags20kg}
                            onChange={handleSmallBags20kgChange}
                            className="mr-2"
                          />
                          Small bags - 20kg/25kg FFS/Laminated PP (15 USD/MT additional)
                        </label>
                      </Tooltip>
                      <Tooltip text="Adds 25 USD per metric ton to the unit price">
                        <label className="flex items-center text-sm text-gray-600">
                          <input
                            type="checkbox"
                            checked={smallBagsKraft}
                            onChange={handleSmallBagsKraftChange}
                            className="mr-2"
                          />
                          Small bags - 20kg/25kg Kraft (25 USD/MT additional)
                        </label>
                      </Tooltip>
                      {errors.smallBags && (
                        <div className="mt-2 flex items-center text-sm text-red-600">
                          <AlertCircle />
                          <span className="ml-1">{errors.smallBags}</span>
                        </div>
                      )}
                      <h3 className="text-base font-medium text-gray-700 mt-4">Boric Acid Options</h3>
                      <Tooltip text="Adds 20 USD per metric ton to the unit price">
                        <label className="flex items-center text-sm text-gray-600">
                          <input
                            type="checkbox"
                            checked={boricAcidLowSulphate}
                            onChange={handleBoricAcidLowSulphateChange}
                            className="mr-2"
                          />
                          Boric Acid with Low Sulphate (20 USD/MT additional)
                        </label>
                      </Tooltip>
                      <Tooltip text="Adds 300 USD per metric ton to the unit price">
                        <label className="flex items-center text-sm text-gray-600">
                          <input
                            type="checkbox"
                            checked={boricAcidUltraLowSulphate}
                            onChange={handleBoricAcidUltraLowSulphateChange}
                            className="mr-2"
                          />
                          Boric Acid with Ultra Low Sulphate (300 USD/MT additional)
                        </label>
                      </Tooltip>
                      {errors.boricAcid && (
                        <div className="mt-2 flex items-center text-sm text-red-600">
                          <AlertCircle />
                          <span className="ml-1">{errors.boricAcid}</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
                <div className="flex space-x-4">
                  <button
                    type="submit"
                    className="flex-1 bg-blue-600 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-700 hover:scale-105 transform transition focus:outline-none focus:ring-2 focus:ring-blue-600 flex items-center justify-center disabled:opacity-50"
                    disabled={isLoading}
                  >
                    {isLoading && <Loader />}
                    <span className={isLoading ? "ml-2" : ""}>{isLoading ? "Calculating..." : "Calculate"}</span>
                  </button>
                  <button
                    type="button"
                    onClick={handleReset}
                    className="flex-1 bg-red-600 text-white font-semibold py-1 px-2 rounded-md hover:bg-red-700 hover:scale-105 transform transition focus:outline-none focus:ring-2 focus:ring-red-600"
                  >
                    Reset
                  </button>
                </div>
                {result && (
                  <div className="mt-6 p-6 bg-gradient-to-r from-blue-50 to-white rounded-lg shadow-md border border-blue-200">
                    <p className="result-text text-center text-lg text-gray-800 mb-4" dangerouslySetInnerHTML={{ __html: result.message }}></p>
                    {result.notes.length > 0 && (
                      <div className="text-left text-sm text-gray-600">
                        {result.notes.map((note, index) => (
                          <p key={index}>{note.text.replace(/<[^>]+>/g, '')}</p>
                        ))}
                      </div>
                    )}
                    <div className="disclaimer-section">
                      Disclaimer: The Estimated Date of Departure (ETD) and Required Date of Arrival (ETA) are based on the order entry into the Online Order system as of {formatFullDateTime(currentTime)}. These dates are subject to change based on operational conditions.
                    </div>
                  </div>
                )}
              </form>
              {result && !result.message.includes("We cannot process the order") && (
                <div className="mt-6">
                  <div className="summary-section">
                    <div className="summary-header">Summary</div>
                    <div className="space-y-4">
                      <div>
                        <h4 className="text-lg font-bold text-blue-800">Shipping Details</h4>
                        <div className="summary-item">
                          <span className="summary-label">Required Date of Arrival (ETA):</span>
                          <span className="summary-value" style={{ fontWeight: 'bold', color: '#808080' }}>{result.summary.eta}</span>
                        </div>
                        <div className="summary-item">
                          <span className="summary-label">Port of Discharge:</span>
                          <span className="summary-value" style={{ fontWeight: 'bold', color: '#10B981' }}>{result.summary.pod}</span>
                        </div>
                        <div className="summary-item">
                          <span className="summary-label">Estimated Date of Departure (ETD):</span>
                          <span className="summary-value" style={{ fontWeight: 'bold', color: '#3B82F6' }}>{result.summary.etd}</span>
                        </div>
                      </div>
                      <div>
                        <h4 className="text-lg font-bold text-blue-800">Timing</h4>
                        <div className="summary-item">
                          <span className="summary-label">Preparation Time Needed:</span>
                          <span className="summary-value">{result.summary.preparationTime}</span>
                        </div>
                        <div className="summary-item">
                          <span className="summary-label">Transit Time:</span>
                          <span className="summary-value">{result.summary.transitTime}</span>
                        </div>
                      </div>
                      {result.summary.unitPrice && (
                        <div>
                          <h4 className="text-lg font-bold text-blue-800">Pricing</h4>
                          <div className="summary-item">
                            <span className="summary-label">Unit Price:</span>
                            <span className="summary-value">{result.summary.unitPrice}</span>
                          </div>
                          <div className="summary-item">
                            <span className="summary-label">Port Additional Price:</span>
                            <span className="summary-value">{result.summary.portAdditionalPrice}</span>
                          </div>
                          <div className="summary-item">
                            <span className="summary-label">Bag Additional Price:</span>
                            <span className="summary-value">{result.summary.bagAdditionalPrice || '0 USD/MT'}</span>
                          </div>
                          <div className="summary-item">
                            <span className="summary-label">Boric Acid Additional Price:</span>
                            <span className="summary-value">{result.summary.boricAcidAdditionalPrice || '0 USD/MT'}</span>
                          </div>
                          <div className="summary-item">
                            <span className="summary-label">Final Price:</span>
                            <span className="summary-value final-price">{result.summary.finalPrice}</span>
                          </div>
                        </div>
                      )}
                    </div>
                    <button
                      onClick={copyResult}
                      className="mt-4 w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-600"
                    >
                      Copy Result
                    </button>
                  </div>
                  <div className="mt-4">
                    <div className="flex justify-between items-center">
                      <h3 className="text-lg font-bold text-blue-800">Recent Results</h3>
                      <button
                        onClick={clearHistory}
                        className="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-600 text-sm"
                      >
                        Clear All
                      </button>
                    </div>
                    {recentCalculations.length > 0 ? (
                      <div className="mt-2">
                        {recentCalculations.map((calc, index) => (
                          <div key={index} className="mt-2 p-3 bg-white border border-gray-200 rounded-md shadow-md">
                            <p className="text-sm text-gray-600" dangerouslySetInnerHTML={{ __html: calc.message }}></p>
                            <span className="text-xs text-gray-400 block mt-1">{calc.timestamp}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-sm text-gray-600 mt-2">No recent calculations</p>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<ETACalculator />, document.getElementById('root'));

    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });
  </script>
</body>
</html>
